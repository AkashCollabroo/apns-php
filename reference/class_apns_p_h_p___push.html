<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>apns-php: ApnsPHP_Push Class Reference</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.6.1 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="main.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li class="current"><a href="annotated.html"><span>Data&nbsp;Structures</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li><a href="dirs.html"><span>Directories</span></a></li>
    </ul>
  </div>
  <div class="tabs">
    <ul>
      <li><a href="annotated.html"><span>Data&nbsp;Structures</span></a></li>
      <li><a href="classes.html"><span>Data&nbsp;Structure&nbsp;Index</span></a></li>
      <li><a href="hierarchy.html"><span>Class&nbsp;Hierarchy</span></a></li>
      <li><a href="functions.html"><span>Data&nbsp;Fields</span></a></li>
    </ul>
  </div>
</div>
<div class="contents">
<h1>ApnsPHP_Push Class Reference<br/>
<small>
[<a class="el" href="group___apns_p_h_p___push.html">Push</a>]</small>
</h1><!-- doxytag: class="ApnsPHP_Push" --><!-- doxytag: inherits="ApnsPHP_Abstract" -->
<p>The Push Notification Provider.  
<a href="#_details">More...</a></p>
<div class="dynheader">
Inheritance diagram for ApnsPHP_Push:</div>
<div class="dynsection">
<div class="center"><img src="class_apns_p_h_p___push__inherit__graph.png" border="0" usemap="#_apns_p_h_p___push_inherit__map" alt="Inheritance graph"/></div>
<map name="_apns_p_h_p___push_inherit__map" id="_apns_p_h_p___push_inherit__map">
<area shape="rect" id="node5" href="class_apns_p_h_p___push___server.html" title="The Push Notification Server Provider." alt="" coords="5,950,296,1399"/><area shape="rect" id="node2" href="class_apns_p_h_p___abstract.html" title="Abstract class: this is the superclass for all Apple Push Notification Service classes..." alt="" coords="20,5,281,611"/></map>
<center><span class="legend">[<a target="top" href="graph_legend.html">legend</a>]</span></center></div>
<div class="dynheader">
Collaboration diagram for ApnsPHP_Push:</div>
<div class="dynsection">
<div class="center"><img src="class_apns_p_h_p___push__coll__graph.png" border="0" usemap="#_apns_p_h_p___push_coll__map" alt="Collaboration graph"/></div>
<map name="_apns_p_h_p___push_coll__map" id="_apns_p_h_p___push_coll__map">
<area shape="rect" id="node2" href="class_apns_p_h_p___abstract.html" title="Abstract class: this is the superclass for all Apple Push Notification Service classes..." alt="" coords="5,157,267,763"/><area shape="rect" id="node4" href="interface_apns_p_h_p___log___interface.html" title="The Log Interface." alt="" coords="45,5,227,91"/></map>
<center><span class="legend">[<a target="top" href="graph_legend.html">legend</a>]</span></center></div>
<table border="0" cellpadding="0" cellspacing="0">
<tr><td colspan="2"><h2>Public Member Functions</h2></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_apns_p_h_p___push.html#aae6a84652eefad4159d44019155cb648">__construct</a> (integer $nEnvironment, string $sProviderCertificateFile)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Constructor.  <a href="#aae6a84652eefad4159d44019155cb648"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_apns_p_h_p___push.html#ac018cd9443834d169616e64dbd91795b">add</a> (<a class="el" href="class_apns_p_h_p___message.html">ApnsPHP_Message</a> $message)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Adds a message to the message queue.  <a href="#ac018cd9443834d169616e64dbd91795b"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">array&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_apns_p_h_p___push.html#a28cb5e78a1805b9a1b643142033dc23b">getQueue</a> (boolean $bEmpty=true)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Returns all messages in the message queue.  <a href="#a28cb5e78a1805b9a1b643142033dc23b"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">integer&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_apns_p_h_p___push.html#a913c8a2582c6ede80899a6ef079745d0">getSendRetryTimes</a> ()</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Get the send retry time value.  <a href="#a913c8a2582c6ede80899a6ef079745d0"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_apns_p_h_p___push.html#ae9399f5ec7881c5d18173def8068108e">send</a> ()</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Sends all messages in the message queue to Apple Push Notification Service.  <a href="#ae9399f5ec7881c5d18173def8068108e"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_apns_p_h_p___push.html#a4fc1ec1138b9f16f3133031875c7dcb5">setSendRetryTimes</a> (integer $nRetryTimes)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Set the send retry times value.  <a href="#a4fc1ec1138b9f16f3133031875c7dcb5"></a><br/></td></tr>
<tr><td colspan="2"><h2>Data Fields</h2></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">const&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_apns_p_h_p___push.html#a74b57f63d77ece5116b5182aa34c9730">COMMAND_PUSH</a> = 0</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight"><b>integer</b> Payload command.  <a href="#a74b57f63d77ece5116b5182aa34c9730"></a><br/></td></tr>
<tr><td colspan="2"><h2>Protected Member Functions</h2></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">string&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_apns_p_h_p___push.html#aa8293c674f1cd08cdbacf26bbd0c3d76">_getBinaryNotification</a> (string $sDeviceToken, string $sPayload)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Generate a binary notification from a device token and a JSON-encoded payload.  <a href="#aa8293c674f1cd08cdbacf26bbd0c3d76"></a><br/></td></tr>
<tr><td colspan="2"><h2>Protected Attributes</h2></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">array&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_apns_p_h_p___push.html#a1719189fd0c52f6747cbafa055260d19">$_aMessageQueue</a> = array()</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Message queue.  <a href="#a1719189fd0c52f6747cbafa055260d19"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_apns_p_h_p___push.html#a109431534e6d7a411266096a7c79cf17">$_aServiceURLs</a></td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight"><b>string</b> Service URLs environments.  <a href="#a109431534e6d7a411266096a7c79cf17"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">integer&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_apns_p_h_p___push.html#a9dd53899bb322e9601a2a91a85b49aa8">$_nSendRetryTimes</a> = 3</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Send retry times.  <a href="#a9dd53899bb322e9601a2a91a85b49aa8"></a><br/></td></tr>
</table>
<hr/><a name="_details"></a><h2>Detailed Description</h2>
<p>The Push Notification Provider. </p>
<p>The class manages a message queue and sends notifications payload to Apple Push Notification Service. </p>

<p>Definition at line <a class="el" href="_push_8php_source.html#l00032">32</a> of file <a class="el" href="_push_8php_source.html">Push.php</a>.</p>
<hr/><h2>Constructor &amp; Destructor Documentation</h2>
<a class="anchor" id="aae6a84652eefad4159d44019155cb648"></a><!-- doxytag: member="ApnsPHP_Push::__construct" ref="aae6a84652eefad4159d44019155cb648" args="(integer $nEnvironment, string $sProviderCertificateFile)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void __construct </td>
          <td>(</td>
          <td class="paramtype">integer $&nbsp;</td>
          <td class="paramname"> <em>nEnvironment</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">string $&nbsp;</td>
          <td class="paramname"> <em>sProviderCertificateFile</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Constructor. </p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>$nEnvironment</em>&nbsp;</td><td>Environment. </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>$sProviderCertificateFile</em>&nbsp;</td><td>Provider certificate file with key (Bundled PEM). </td></tr>
  </table>
  </dd>
</dl>

<p>Reimplemented from <a class="el" href="class_apns_p_h_p___abstract.html#aae6a84652eefad4159d44019155cb648">ApnsPHP_Abstract</a>.</p>

<p>Reimplemented in <a class="el" href="class_apns_p_h_p___push___server.html#aae6a84652eefad4159d44019155cb648">ApnsPHP_Push_Server</a>.</p>

<p>Definition at line <a class="el" href="_push_8php_source.html#l00052">52</a> of file <a class="el" href="_push_8php_source.html">Push.php</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00053"></a>00053     {
<a name="l00054"></a>00054         <a class="code" href="class_apns_p_h_p___push.html#aae6a84652eefad4159d44019155cb648" title="Constructor.">parent::__construct</a>($nEnvironment, $sProviderCertificateFile);
<a name="l00055"></a>00055         $this-&gt;_nSendRetryTimes = self::SEND_RETRY_TIMES;
<a name="l00056"></a>00056     }
</pre></div></p>

</div>
</div>
<hr/><h2>Member Function Documentation</h2>
<a class="anchor" id="aa8293c674f1cd08cdbacf26bbd0c3d76"></a><!-- doxytag: member="ApnsPHP_Push::_getBinaryNotification" ref="aa8293c674f1cd08cdbacf26bbd0c3d76" args="(string $sDeviceToken, string $sPayload)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">string _getBinaryNotification </td>
          <td>(</td>
          <td class="paramtype">string $&nbsp;</td>
          <td class="paramname"> <em>sDeviceToken</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">string $&nbsp;</td>
          <td class="paramname"> <em>sPayload</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [protected]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Generate a binary notification from a device token and a JSON-encoded payload. </p>
<dl class="see"><dt><b>See also:</b></dt><dd><a href="http://tinyurl.com/ApplePushNotificationBinary">http://tinyurl.com/ApplePushNotificationBinary</a></dd></dl>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>$sDeviceToken</em>&nbsp;</td><td>The device token. </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>$sPayload</em>&nbsp;</td><td>The JSON-encoded payload. </td></tr>
  </table>
  </dd>
</dl>
<dl class="return"><dt><b>Returns:</b></dt><dd>A binary notification. </dd></dl>

<p>Definition at line <a class="el" href="_push_8php_source.html#l00194">194</a> of file <a class="el" href="_push_8php_source.html">Push.php</a>.</p>

<p>Referenced by <a class="el" href="_push_8php_source.html#l00086">add()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00195"></a>00195     {
<a name="l00196"></a>00196         $nTokenLength = strlen($sDeviceToken);
<a name="l00197"></a>00197         $nPayloadLength = strlen($sPayload);
<a name="l00198"></a>00198 
<a name="l00199"></a>00199         $sRet  = pack(<span class="stringliteral">&apos;CnH*&apos;</span>, self::COMMAND_PUSH, self::DEVICE_BINARY_SIZE, $sDeviceToken);
<a name="l00200"></a>00200         $sRet .= pack(<span class="charliteral">&apos;n&apos;</span>, $nPayloadLength);
<a name="l00201"></a>00201         $sRet .= $sPayload;
<a name="l00202"></a>00202         
<a name="l00203"></a>00203         <span class="keywordflow">return</span> $sRet;
<a name="l00204"></a>00204     }
</pre></div></p>

<p><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dynsection">
<div class="center"><img src="class_apns_p_h_p___push_aa8293c674f1cd08cdbacf26bbd0c3d76_icgraph.png" border="0" usemap="#class_apns_p_h_p___push_aa8293c674f1cd08cdbacf26bbd0c3d76_icgraph_map" alt=""></div>
<map name="class_apns_p_h_p___push_aa8293c674f1cd08cdbacf26bbd0c3d76_icgraph_map" id="class_apns_p_h_p___push_aa8293c674f1cd08cdbacf26bbd0c3d76_icgraph">
<area shape="rect" id="node3" href="class_apns_p_h_p___push.html#ac018cd9443834d169616e64dbd91795b" title="Adds a message to the message queue." alt="" coords="228,5,273,35"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="ac018cd9443834d169616e64dbd91795b"></a><!-- doxytag: member="ApnsPHP_Push::add" ref="ac018cd9443834d169616e64dbd91795b" args="(ApnsPHP_Message $message)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void add </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="class_apns_p_h_p___message.html">ApnsPHP_Message</a> $&nbsp;</td>
          <td class="paramname"> <em>message</em></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Adds a message to the message queue. </p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>$message</em>&nbsp;</td><td>The message. </td></tr>
  </table>
  </dd>
</dl>

<p>Reimplemented in <a class="el" href="class_apns_p_h_p___push___server.html#ac018cd9443834d169616e64dbd91795b">ApnsPHP_Push_Server</a>.</p>

<p>Definition at line <a class="el" href="_push_8php_source.html#l00086">86</a> of file <a class="el" href="_push_8php_source.html">Push.php</a>.</p>

<p>References <a class="el" href="_push_8php_source.html#l00194">_getBinaryNotification()</a>, <a class="el" href="_message_8php_source.html#l00078">ApnsPHP_Message::getRecipient()</a>, and <a class="el" href="_message_8php_source.html#l00093">ApnsPHP_Message::getRecipientsNumber()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00087"></a>00087     {
<a name="l00088"></a>00088         $sMessagePayload = (string)$message;
<a name="l00089"></a>00089         $nRecipients = $message-&gt;getRecipientsNumber();
<a name="l00090"></a>00090         
<a name="l00091"></a>00091         <span class="keywordflow">for</span> ($i = 0; $i &lt; $nRecipients; $i++) { 
<a name="l00092"></a>00092             $this-&gt;_aMessageQueue[] = array(
<a name="l00093"></a>00093                 <span class="stringliteral">&apos;MESSAGE&apos;</span> =&gt; $message,
<a name="l00094"></a>00094                 <span class="stringliteral">&apos;BINARY_NOTIFICATION&apos;</span> =&gt; $this-&gt;<a class="code" href="class_apns_p_h_p___push.html#aa8293c674f1cd08cdbacf26bbd0c3d76" title="Generate a binary notification from a device token and a JSON-encoded payload.">_getBinaryNotification</a>(
<a name="l00095"></a>00095                     $message-&gt;getRecipient($i),
<a name="l00096"></a>00096                     $sMessagePayload
<a name="l00097"></a>00097                 ),
<a name="l00098"></a>00098                 <span class="stringliteral">&apos;RETRY_TIMES&apos;</span> =&gt; 0
<a name="l00099"></a>00099             );
<a name="l00100"></a>00100         }
<a name="l00101"></a>00101     }
</pre></div></p>

<p><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dynsection">
<div class="center"><img src="class_apns_p_h_p___push_ac018cd9443834d169616e64dbd91795b_cgraph.png" border="0" usemap="#class_apns_p_h_p___push_ac018cd9443834d169616e64dbd91795b_cgraph_map" alt=""></div>
<map name="class_apns_p_h_p___push_ac018cd9443834d169616e64dbd91795b_cgraph_map" id="class_apns_p_h_p___push_ac018cd9443834d169616e64dbd91795b_cgraph">
<area shape="rect" id="node3" href="class_apns_p_h_p___push.html#aa8293c674f1cd08cdbacf26bbd0c3d76" title="Generate a binary notification from a device token and a JSON&#45;encoded payload." alt="" coords="169,5,343,35"/><area shape="rect" id="node5" href="class_apns_p_h_p___message.html#a46f33ab42d194e1b7a108f2fb287627b" title="Get a recipient." alt="" coords="132,59,380,88"/><area shape="rect" id="node7" href="class_apns_p_h_p___message.html#ae6c898739424a186c74c6d8541fbb5f5" title="Get the number of recipients." alt="" coords="103,112,409,141"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="a28cb5e78a1805b9a1b643142033dc23b"></a><!-- doxytag: member="ApnsPHP_Push::getQueue" ref="a28cb5e78a1805b9a1b643142033dc23b" args="(boolean $bEmpty=true)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">array getQueue </td>
          <td>(</td>
          <td class="paramtype">boolean $&nbsp;</td>
          <td class="paramname"> <em>bEmpty</em> = <code>true</code></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Returns all messages in the message queue. </p>
<p>When a message is successful sent is removed from the message queue. Getting the message queue after a send operation is useful to know which messages are not delivered to the end user.</p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>$bEmpty</em>&nbsp;</td><td>[optional] Empty message queue. </td></tr>
  </table>
  </dd>
</dl>
<dl class="return"><dt><b>Returns:</b></dt><dd>Array of messages left on the queue. </dd></dl>

<p>Reimplemented in <a class="el" href="class_apns_p_h_p___push___server.html#a28cb5e78a1805b9a1b643142033dc23b">ApnsPHP_Push_Server</a>.</p>

<p>Definition at line <a class="el" href="_push_8php_source.html#l00176">176</a> of file <a class="el" href="_push_8php_source.html">Push.php</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00177"></a>00177     {
<a name="l00178"></a>00178         $aRet = $this-&gt;_aMessageQueue;
<a name="l00179"></a>00179         <span class="keywordflow">if</span> ($bEmpty) {
<a name="l00180"></a>00180             $this-&gt;_aMessageQueue = array();
<a name="l00181"></a>00181         }
<a name="l00182"></a>00182         <span class="keywordflow">return</span> $aRet;
<a name="l00183"></a>00183     }
</pre></div></p>

</div>
</div>
<a class="anchor" id="a913c8a2582c6ede80899a6ef079745d0"></a><!-- doxytag: member="ApnsPHP_Push::getSendRetryTimes" ref="a913c8a2582c6ede80899a6ef079745d0" args="()" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">integer getSendRetryTimes </td>
          <td>(</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Get the send retry time value. </p>
<dl class="return"><dt><b>Returns:</b></dt><dd>Send retry times. </dd></dl>

<p>Definition at line <a class="el" href="_push_8php_source.html#l00076">76</a> of file <a class="el" href="_push_8php_source.html">Push.php</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00077"></a>00077     {
<a name="l00078"></a>00078         <span class="keywordflow">return</span> $this-&gt;_nSendRetryTimes;
<a name="l00079"></a>00079     }
</pre></div></p>

</div>
</div>
<a class="anchor" id="ae9399f5ec7881c5d18173def8068108e"></a><!-- doxytag: member="ApnsPHP_Push::send" ref="ae9399f5ec7881c5d18173def8068108e" args="()" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void send </td>
          <td>(</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Sends all messages in the message queue to Apple Push Notification Service. </p>
<dl><dt><b>Exceptions:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em><a class="el" href="class_apns_p_h_p___push___exception.html" title="Exception class.">ApnsPHP_Push_Exception</a></em>&nbsp;</td><td>if not connected to the service or no notification queued. </td></tr>
  </table>
  </dd>
</dl>

<p>Definition at line <a class="el" href="_push_8php_source.html#l00109">109</a> of file <a class="el" href="_push_8php_source.html">Push.php</a>.</p>

<p>References <a class="el" href="_abstract_8php_source.html#l00363">ApnsPHP_Abstract::_log()</a>, <a class="el" href="_abstract_8php_source.html#l00282">ApnsPHP_Abstract::connect()</a>, and <a class="el" href="_abstract_8php_source.html#l00310">ApnsPHP_Abstract::disconnect()</a>.</p>

<p>Referenced by <a class="el" href="_server_8php_source.html#l00249">ApnsPHP_Push_Server::_mainLoop()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00110"></a>00110     {
<a name="l00111"></a>00111         <span class="keywordflow">if</span> (!$this-&gt;_hSocket) {
<a name="l00112"></a>00112             <span class="keywordflow">throw</span> <span class="keyword">new</span> <a class="code" href="class_apns_p_h_p___push___exception.html" title="Exception class.">ApnsPHP_Push_Exception</a>(
<a name="l00113"></a>00113                 <span class="stringliteral">&apos;Not connected to Push Notification Service&apos;</span>
<a name="l00114"></a>00114             );
<a name="l00115"></a>00115         }
<a name="l00116"></a>00116 
<a name="l00117"></a>00117         <span class="keywordflow">if</span> (empty($this-&gt;_aMessageQueue)) {
<a name="l00118"></a>00118             <span class="keywordflow">throw</span> <span class="keyword">new</span> <a class="code" href="class_apns_p_h_p___push___exception.html" title="Exception class.">ApnsPHP_Push_Exception</a>(
<a name="l00119"></a>00119                 <span class="stringliteral">&apos;No notifications queued to be sent&apos;</span>
<a name="l00120"></a>00120             );
<a name="l00121"></a>00121         }
<a name="l00122"></a>00122 
<a name="l00123"></a>00123         <span class="keywordflow">foreach</span>($this-&gt;_aMessageQueue as $k =&gt; &amp;$aMessage) {
<a name="l00124"></a>00124             $bSuccessfulSent = <span class="keyword">false</span>;
<a name="l00125"></a>00125             <span class="keywordflow">while</span> ($bSuccessfulSent == <span class="keyword">false</span> &amp;&amp; $aMessage[<span class="stringliteral">&apos;RETRY_TIMES&apos;</span>] &lt;= $this-&gt;_nSendRetryTimes) {
<a name="l00126"></a>00126                 pcntl_signal_dispatch();
<a name="l00127"></a>00127                 <span class="keywordflow">if</span> ($aMessage[<span class="stringliteral">&apos;RETRY_TIMES&apos;</span>] &gt; 0) {
<a name="l00128"></a>00128                     $this-&gt;<a class="code" href="class_apns_p_h_p___abstract.html#a6e9fdc68fece1907733a1e76f667622f" title="Logs a message through the Logger.">_log</a>(
<a name="l00129"></a>00129                         <span class="stringliteral">&apos;INFO: Retrying to send message &apos;</span> . ($k+1) . <span class="stringliteral">&quot; (&quot;</span> .
<a name="l00130"></a>00130                         <span class="stringliteral">&quot;{$aMessage[&apos;RETRY_TIMES&apos;]}/&quot;</span> . $this-&gt;_nSendRetryTimes . <span class="stringliteral">&apos;)...&apos;</span>
<a name="l00131"></a>00131                     );
<a name="l00132"></a>00132                 }
<a name="l00133"></a>00133                 
<a name="l00134"></a>00134                 $aMessage[<span class="stringliteral">&apos;RETRY_TIMES&apos;</span>]++;
<a name="l00135"></a>00135                 
<a name="l00136"></a>00136                 $nLen = strlen($aMessage[<span class="stringliteral">&apos;BINARY_NOTIFICATION&apos;</span>]);
<a name="l00137"></a>00137                 <span class="keywordflow">if</span> ($nLen !== ($nWritten = (<span class="keywordtype">int</span>)@fwrite($this-&gt;_hSocket, $aMessage[<span class="stringliteral">&apos;BINARY_NOTIFICATION&apos;</span>]))) {
<a name="l00138"></a>00138                     $this-&gt;<a class="code" href="class_apns_p_h_p___abstract.html#a6e9fdc68fece1907733a1e76f667622f" title="Logs a message through the Logger.">_log</a>(<span class="stringliteral">&quot;ERROR: Unable to send message. Written {$nWritten} bytes instead of {$nLen} bytes&quot;</span>);
<a name="l00139"></a>00139                     <span class="keywordflow">continue</span>;
<a name="l00140"></a>00140                 }
<a name="l00141"></a>00141 
<a name="l00142"></a>00142                 $bSuccessfulSent = <span class="keyword">true</span>;
<a name="l00143"></a>00143 
<a name="l00144"></a>00144                 $read = array($this-&gt;_hSocket);
<a name="l00145"></a>00145                 $null = NULL;
<a name="l00146"></a>00146                 $nChangedStreams = @stream_select($read, $null, $null, 0, $this-&gt;_nSocketSelectTimeout);
<a name="l00147"></a>00147                 <span class="keywordflow">if</span> ($nChangedStreams === <span class="keyword">false</span>) {
<a name="l00148"></a>00148                     $this-&gt;<a class="code" href="class_apns_p_h_p___abstract.html#a6e9fdc68fece1907733a1e76f667622f" title="Logs a message through the Logger.">_log</a>(<span class="stringliteral">&apos;WARNING: Unable to wait for a stream availability.&apos;</span>);
<a name="l00149"></a>00149                 } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($nChangedStreams &gt; 0) {
<a name="l00150"></a>00150                     <span class="keywordflow">if</span> (feof($this-&gt;_hSocket)) {
<a name="l00151"></a>00151                         $bSuccessfulSent = <span class="keyword">false</span>;
<a name="l00152"></a>00152                         $this-&gt;<a class="code" href="class_apns_p_h_p___abstract.html#a6e9fdc68fece1907733a1e76f667622f" title="Logs a message through the Logger.">_log</a>(<span class="stringliteral">&apos;ERROR: Unable to send message &apos;</span> . ($k+1) . <span class="stringliteral">&apos;, stream could be no more connected.&apos;</span>);
<a name="l00153"></a>00153                         $this-&gt;<a class="code" href="class_apns_p_h_p___abstract.html#a7df1b1c18902634d60f5fb06d3c5f4a9" title="Disconnects from Apple Push Notifications service server.">disconnect</a>();
<a name="l00154"></a>00154                         $this-&gt;<a class="code" href="class_apns_p_h_p___abstract.html#a1396bf9b5defe9fa844a63b5cd40ac0e" title="Connects to Apple Push Notification service server.">connect</a>();
<a name="l00155"></a>00155                     }
<a name="l00156"></a>00156                 }
<a name="l00157"></a>00157             }
<a name="l00158"></a>00158 
<a name="l00159"></a>00159             <span class="keywordflow">if</span> ($bSuccessfulSent) {
<a name="l00160"></a>00160                 $this-&gt;<a class="code" href="class_apns_p_h_p___abstract.html#a6e9fdc68fece1907733a1e76f667622f" title="Logs a message through the Logger.">_log</a>(<span class="stringliteral">&apos;INFO: Message &apos;</span> . ($k+1) . <span class="stringliteral">&apos; sent.&apos;</span>);
<a name="l00161"></a>00161                 unset($this-&gt;_aMessageQueue[$k]);
<a name="l00162"></a>00162             }
<a name="l00163"></a>00163         }
<a name="l00164"></a>00164     }
</pre></div></p>

<p><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dynsection">
<div class="center"><img src="class_apns_p_h_p___push_ae9399f5ec7881c5d18173def8068108e_cgraph.png" border="0" usemap="#class_apns_p_h_p___push_ae9399f5ec7881c5d18173def8068108e_cgraph_map" alt=""></div>
<map name="class_apns_p_h_p___push_ae9399f5ec7881c5d18173def8068108e_cgraph_map" id="class_apns_p_h_p___push_ae9399f5ec7881c5d18173def8068108e_cgraph">
<area shape="rect" id="node3" href="class_apns_p_h_p___abstract.html#a6e9fdc68fece1907733a1e76f667622f" title="Logs a message through the Logger." alt="" coords="653,37,837,66"/><area shape="rect" id="node5" href="class_apns_p_h_p___abstract.html#a1396bf9b5defe9fa844a63b5cd40ac0e" title="Connects to Apple Push Notification service server." alt="" coords="111,37,324,66"/><area shape="rect" id="node11" href="class_apns_p_h_p___abstract.html#a7df1b1c18902634d60f5fb06d3c5f4a9" title="Disconnects from Apple Push Notifications service server." alt="" coords="373,116,605,145"/><area shape="rect" id="node7" href="class_apns_p_h_p___abstract.html#a56e16b11db21be37c5f50850d287ff21" title="Connects to Apple Push Notification service server." alt="" coords="379,62,600,92"/></map>
</div>
</p>

<p><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dynsection">
<div class="center"><img src="class_apns_p_h_p___push_ae9399f5ec7881c5d18173def8068108e_icgraph.png" border="0" usemap="#class_apns_p_h_p___push_ae9399f5ec7881c5d18173def8068108e_icgraph_map" alt=""></div>
<map name="class_apns_p_h_p___push_ae9399f5ec7881c5d18173def8068108e_icgraph_map" id="class_apns_p_h_p___push_ae9399f5ec7881c5d18173def8068108e_icgraph">
<area shape="rect" id="node3" href="class_apns_p_h_p___push___server.html#a8ef2832f45586e32845c0d866d9e96cf" title="The process main loop." alt="" coords="109,5,363,35"/><area shape="rect" id="node5" href="class_apns_p_h_p___push___server.html#a60de64d75454385b23995437f1d72669" title="Starts the server forking all processes and return immediately." alt="" coords="411,5,627,35"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="a4fc1ec1138b9f16f3133031875c7dcb5"></a><!-- doxytag: member="ApnsPHP_Push::setSendRetryTimes" ref="a4fc1ec1138b9f16f3133031875c7dcb5" args="(integer $nRetryTimes)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void setSendRetryTimes </td>
          <td>(</td>
          <td class="paramtype">integer $&nbsp;</td>
          <td class="paramname"> <em>nRetryTimes</em></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Set the send retry times value. </p>
<p>If the client is unable to send a payload to to the server retries at least for this value. The default send retry times is 3.</p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>$nRetryTimes</em>&nbsp;</td><td>Send retry times. </td></tr>
  </table>
  </dd>
</dl>

<p>Definition at line <a class="el" href="_push_8php_source.html#l00066">66</a> of file <a class="el" href="_push_8php_source.html">Push.php</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00067"></a>00067     {
<a name="l00068"></a>00068         $this-&gt;_nSendRetryTimes = (int)$nRetryTimes;
<a name="l00069"></a>00069     }
</pre></div></p>

</div>
</div>
<hr/><h2>Field Documentation</h2>
<a class="anchor" id="a1719189fd0c52f6747cbafa055260d19"></a><!-- doxytag: member="ApnsPHP_Push::$_aMessageQueue" ref="a1719189fd0c52f6747cbafa055260d19" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">array $_aMessageQueue = array()<code> [protected]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Message queue. </p>

<p>Definition at line <a class="el" href="_push_8php_source.html#l00043">43</a> of file <a class="el" href="_push_8php_source.html">Push.php</a>.</p>

</div>
</div>
<a class="anchor" id="a109431534e6d7a411266096a7c79cf17"></a><!-- doxytag: member="ApnsPHP_Push::$_aServiceURLs" ref="a109431534e6d7a411266096a7c79cf17" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">$_aServiceURLs<code> [protected]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<b>Initial value:</b><div class="fragment"><pre class="fragment"> array(
        <span class="stringliteral">&apos;ssl://gateway.push.apple.com:2195&apos;</span>, 
        <span class="stringliteral">&apos;ssl://gateway.sandbox.push.apple.com:2195&apos;</span> 
    )
</pre></div>
<p><b>string</b> Service URLs environments. </p>

<p>Reimplemented from <a class="el" href="class_apns_p_h_p___abstract.html#a4dfe522758b48c95d52c2ec5b90fd18f">ApnsPHP_Abstract</a>.</p>

<p>Definition at line <a class="el" href="_push_8php_source.html#l00038">38</a> of file <a class="el" href="_push_8php_source.html">Push.php</a>.</p>

</div>
</div>
<a class="anchor" id="a9dd53899bb322e9601a2a91a85b49aa8"></a><!-- doxytag: member="ApnsPHP_Push::$_nSendRetryTimes" ref="a9dd53899bb322e9601a2a91a85b49aa8" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">integer $_nSendRetryTimes = 3<code> [protected]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Send retry times. </p>

<p>Definition at line <a class="el" href="_push_8php_source.html#l00036">36</a> of file <a class="el" href="_push_8php_source.html">Push.php</a>.</p>

</div>
</div>
<a class="anchor" id="a74b57f63d77ece5116b5182aa34c9730"></a><!-- doxytag: member="ApnsPHP_Push::COMMAND_PUSH" ref="a74b57f63d77ece5116b5182aa34c9730" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">const <a class="el" href="class_apns_p_h_p___push.html#a74b57f63d77ece5116b5182aa34c9730">COMMAND_PUSH</a> = 0</td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p><b>integer</b> Payload command. </p>

<p>Definition at line <a class="el" href="_push_8php_source.html#l00034">34</a> of file <a class="el" href="_push_8php_source.html">Push.php</a>.</p>

</div>
</div>
<hr/>The documentation for this class was generated from the following file:<ul>
<li><a class="el" href="_push_8php_source.html">Push.php</a></li>
</ul>
</div>
<hr size="1"/><address style="text-align: right;"><small>Generated on Sun Feb 28 01:00:01 2010 for apns-php by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.6.1 </small></address>
</body>
</html>
